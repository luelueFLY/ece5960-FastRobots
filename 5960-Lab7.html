<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Lab7 - Lanyue Fang's Fast Robots</title>
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v5.15.4/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css" />
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
    </head>
    <body>
        <!-- Navigation-->
        <nav class="navbar navbar-expand-lg navbar-light" id="mainNav">
            <div class="container px-4 px-lg-5">
                <a class="navbar-brand" href="index.html">ECE5960 FAST ROBOTS</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                    Menu
                    <i class="fas fa-bars"></i>
                </button>
                <div class="collapse navbar-collapse" id="navbarResponsive">
                    <ul class="navbar-nav ms-auto py-4 py-lg-0">
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="index.html">Home</a></li>
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="about.html">About Me</a></li>
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="5960-Lab6.html">Previous</a></li>
                    </ul>
                </div>
            </div>
        </nav>
        <!-- Page Header-->
        <header class="masthead" style="background-image: url('assets/img/post-bg.jpg')">
            <div class="container position-relative px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-md-10 col-lg-8 col-xl-7">
                        <div class="post-heading">
                            <h1>Lab7 Kalman Filter</h1>
                            <h2 class="subheading">Implement a Kalman Filter!</h2>
                            <p class="post-meta">
                                Posted by
                                Lanyue Fang
                                on Mar 21, 2022
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Post Content-->
        <article class="mb-4">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-md-10 col-lg-8 col-xl-7">

                        
                        <h2 class="section-heading">Parts Required</h2>
                        <p>
                            1 x Fully assembled robot, with Artemis, batteries, ToF sensor, and IMU.
                        </p>

                        <h2 class="section-heading">State Space Equations</h2>
                        <p>
                            Task Descriptionï¼š the robot will drive fast forward towards a wall until the distance is less than 800mm, then turn with drift to do a 180-degree turn, 
                            and return the direction it came from without stopping.
                            <p></p>
                            In this lab, I am going to use sensor fusion to help estimate the distance to the wall frequently, 
                            despite the slow sampling time of the ToF sensor.
                            According to the 
                            <a href="https://cei-lab.github.io/ECE4960-2022/lectures/FastRobots-12-KF-Navigation.pdf">lecture 12</a>, 
                            the state is [x,v]' (2-by-1 vector), while the measurement is the distance from the front of the car to the wall, obtained by the ToF sensor. 
                            The combined force is input u minus damping force. The equations are shown below.
                            <p><img class="img-fluid" src="assets/img/Lab7/equations.PNG"></p> 
                            
                                                        
                        </p>
                        
                        <h2 class="section-heading">Step Response</h2>
                        <p>
                            To get the A and B matrices, we need to estimate d and m through a step response. 
                            I made the car drive towards a wall while logging the distances and timestamps. 
                            The PWM value was 50 when the distance was larger than 800 mm. 
                            Otherwise, the car would stop immediately to avoid a collision. 
                            I put the car around four meters away from the wall, which was long enough for the car to reach a steady state. 
                            four meters is also the maximum measurement length of the ToF sensor. 
                            <p></p>
                            I got the distances, timestamps and the motor input value from the debugging data and then calculated the velocity. 
                            <p class="text-center"><img src="assets/img/Lab7/combine.png"></p>
                            The steady speed was around 1580 mm/s and the rise time was nearly 0.5144 s. 
                            And then we were able to get the d and m.
                            <p class="text-center"><img src="assets/img/Lab7/step response.PNG"></p>                                             
                        </p>


                        <h2 class="section-heading">Kalman Filter Setup</h2>
                        <p>
                            <h3>A, B, C Matrics</h3>
                            <p>
                                According to the state space equations and step response, we can then get the A and B matrics. 
                                In my model, the A = [0,1;0,-4.476], and B = [0;7072.48]. 
                                Since the distances are measured discretely, the discrete A and B is going to be: 
                                <p><img class="img-fluid" src="assets/img/Lab7/AdBd.PNG"></p>
                                I roughly took the first period as the delta_t, which was 0.09696 s. 
                                Here is the related code in python.
                                <p class="text-center"><img src="assets/img/Lab7/matrics.PNG"></p>

                            </p>

                            <h3>Process noise and Sensor noise Covariance Matrices</h3>
                            <p>
                                Reasonable process noise and sensor noise covariance matrices are important in the Kalman Filter. 
                                If the process noise is larger, Kalman Filter will trust more on the measurements. 
                                While if the sensor noise is too big, the model will give more confidence to the prediction of the dynamic. 
                                However, if the values are set too small, the Kalman Filter will not work, if the values are too big, it will barely respond. 
                                I set the noise covariance matrices the same as in the slides: sigma_u=[27.7^2,0;0,27.7^2], sigma_z=20^2;
                                Later, I tuned them and got different Kalman Filter outputs.

                            </p>                            


                        </p>

                        <h2 class="section-heading">Sanity Check the Kalman Filter</h2>
                        <p>
                            <h3>Initial State and Sigma</h3>
                            <p>
                                I determined the origin of the x to be the wall and the positive direction of x-axis is the direction of car movement. 
                                Therefore, -distance[0] and velocity[0] was the initial state. 
                                The initial sigma was set to [5^2,0;0,5].

                            </p>

                            <h3>Kalman Filter Function</h3>
                            <p>
                                There are two main steps in the Kalman Filter: prediction and update. 
                                'prediction' calculates the mu_bar and sigma_bar according to the last time state and the control u. 
                                And kalman gain is determined by the sigma_bar, process and sensor noise covariance matrices. 
                                With smaller measurement noise, kalman gain is going to be bigger and give more trust on measurements. 
                                In the update step, mu equals mu_bar plus kalman gain multiplied by the difference between the true and expected measurements. 
                                Here is the related function. 
                                <p class="text-center"><img src="assets/img/Lab7/KF.PNG"></p>

                            </p>


                            <h3>Kalman Filter Output</h3>
                            <p>
                                I tried the Kalman Filter with different process noise and sensor noise. 
                                As shown in the figures, if the sensor noise is relatively smaller, the distances will be closer to the measured values. 
                                With sigma_u=[27.7^2,0;0,27.7^2] and sigma_z=20^2, output KF distances are aligned with the measurements well.
                                <p><img class="img-fluid" src="assets/img/Lab7/00.PNG"></p>

                            </p>


                        </p>

                        <h2 class="section-heading">Implement Kalman Filter on the Robot</h2>
                        <p>
                            By implementing the model above in the robot, we can get a faster controller. 
                            If the ToF sensor data is not ready, I will set the d_tof to be -100, indicating it is unavailable. 
                            Then Kalman Filter will do the prediction only so that we can still get the distance information and generate a motor input value. 
                            While the sensor is ready, both prediction and update will be executed. 
                            Here is the Kalman Filter function in Arduino. 
<!-- 
                            <p><img class="img-fluid" src="assets/img/Lab7/KF_arduino.PNG"></p>
 -->



        
                       
                        

                        </p>

                        <span class="caption text-muted">
                            Posted by <a href="about.html">Lanyue Fang</a>
                            on Mar 21, 2022
                        </span>

                        
                       


                    </div>
                </div>
            </div>
        </article>
        <!-- Footer-->
        <footer class="border-top">
            <div class="container px-4 px-lg-5">
                <div class="row gx-4 gx-lg-5 justify-content-center">
                    <div class="col-md-10 col-lg-8 col-xl-7">
                        <div class="small text-center text-muted fst-italic">Copyright &copy; Lanyue Fang 2022</div>
                    </div>
                </div>
            </div>
        </footer>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
    </body>
</html>
